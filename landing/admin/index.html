<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîê DMS Email Security System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #0a1a1a;
            color: #ffffff;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            color: #14b8a6;
        }

        .section {
            background: #0b1220;
            border: 2px solid #14b8a6;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
        }

        .section h2 {
            color: #14b8a6;
            margin-bottom: 20px;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .config-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .config-item {
            background: #0a1a1a;
            padding: 15px;
            border-radius: 10px;
            border: 1px solid rgba(20, 184, 166, 0.3);
        }

        .config-item label {
            display: block;
            margin-bottom: 8px;
            color: #14b8a6;
            font-weight: bold;
        }

        .config-item input, .config-item select {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            background: #0a1a1a;
            color: #ffffff;
            font-size: 14px;
            border: 1px solid rgba(20, 184, 166, 0.4);
        }

        .config-item input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 14px;
        }

        .status-online {
            background: rgba(0, 255, 0, 0.2);
            color: #00ff00;
            border: 1px solid #00ff00;
        }

        .status-offline {
            background: rgba(255, 0, 0, 0.2);
            color: #ff4444;
            border: 1px solid #ff4444;
        }

        .btn {
            background: linear-gradient(135deg, #00d4aa 0%, #00a085 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-top: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 212, 170, 0.4);
        }

        .btn:disabled {
            background: rgba(255, 255, 255, 0.2);
            cursor: not-allowed;
            transform: none;
        }

        .error-message {
            background: rgba(255, 0, 0, 0.2);
            border: 1px solid #ff4444;
            color: #ff4444;
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
        }

        .success-message {
            background: rgba(0, 255, 0, 0.2);
            border: 1px solid #00ff00;
            color: #00ff00;
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
        }

        .steps-list {
            list-style: none;
            padding: 0;
        }

        .steps-list li {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 10px 0;
            border-bottom: 1px solid rgba(20, 184, 166, 0.2);
        }

        .step-number {
            background: #14b8a6;
            color: #0b1220;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            flex-shrink: 0;
        }

        .api-endpoint {
            background: #0a1a1a;
            padding: 10px 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            margin: 5px 0;
            border-left: 4px solid #14b8a6;
            border: 1px solid rgba(20, 184, 166, 0.3);
        }

        .sessions-container {
            background: #0b1220;
            border-radius: 10px;
            padding: 20px;
            margin-top: 15px;
            border: 1px solid rgba(20, 184, 166, 0.3);
        }

        .session-item {
            background: #0a1a1a;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid rgba(20, 184, 166, 0.2);
        }

        .timer-highlight {
            color: #ffa500;
            font-weight: bold;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(0, 212, 170, 0.3);
            border-radius: 50%;
            border-top-color: #00d4aa;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîê DMS Email Security System</h1>
            <p>üöÄ Sistema di Controllo Accessi Email</p>
            <p>Gestione avanzata delle sessioni di accesso con autenticazione email e timer intelligente</p>
        </div>

        <!-- Sistema Email Attivo -->
        <div class="section">
            <h2>üîê Sistema Email</h2>
            
            <div class="config-item">
                <div class="status-indicator status-online">
                    ‚úÖ Sistema email attivo - Invio tramite GitHub Issues
                </div>
                <small style="color: rgba(255,255,255,0.7); display: block; margin-top: 10px;">
                    Il sistema utilizza GitHub Issues per attivare il workflow di invio email SMTP.
                    Non sono necessari token o autenticazioni aggiuntive.
                </small>
            </div>
        </div>

        <!-- Configurazione Backend -->
        <div class="section">
            <h2>‚öôÔ∏è Configurazione Backend</h2>
            
            <div class="config-item">
                <label>üõ°Ô∏è Sistema Email:</label>
                <div style="background: rgba(255, 165, 0, 0.2); padding: 10px; border-radius: 8px; border: 1px solid #ffa500;">
                    info@dms.associates configurato con PostaSSL
                </div>
            </div>

            <div class="config-item">
                <label>üåê URL Backend API:</label>
                <input type="text" id="backendUrl" value="https://chcndr.github.io/dms-sicurezza-mail-test/api" readonly>
                <small style="color: rgba(255,255,255,0.7);">Endpoint per le chiamate API del sistema email</small>
            </div>

            <div class="config-grid">
                <div class="config-item">
                    <label>üìß Email Mittente (DMS):</label>
                    <input type="text" value="info@dms.associates" readonly>
                </div>
                <div class="config-item">
                    <label>üì¨ Email Sistema (CC):</label>
                    <input type="text" value="dms-sicurezza-mail-test@noreply.github.com" readonly>
                    <small style="color: rgba(255,255,255,0.7);">Solo sistema di sblocco GitHub (risposte vanno automaticamente a info@dms.associates)</small>
                </div>
                <div class="config-item">
                    <label>üì° Status Sistema:</label>
                    <div class="status-indicator" id="systemStatus">
                        <div class="loading"></div>
                        <span>Verificando...</span>
                    </div>
                </div>
            </div>

            <div class="config-grid">
                <div class="config-item">
                    <label>üåê Server SMTP:</label>
                    <input type="text" value="out.postassl.it:465 (SSL)" readonly>
                </div>
                <div class="config-item">
                    <label>üì® Server IMAP:</label>
                    <input type="text" value="in.postassl.it:993 (SSL)" readonly>
                </div>
            </div>
        </div>

        <!-- Configurazione GitHub API -->
        <div class="section">
            <h2>üîë Configurazione GitHub API</h2>
            
            <div class="config-grid">
                <div class="config-item">
                    <label>üîë Token GitHub API:</label>
                    <input type="password" id="githubToken" placeholder="ghp_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx">
                    <small style="color: #14b8a6; margin-top: 5px; display: block;">Token per creare automaticamente gli Issues GitHub (inserisci una volta sola)</small>
                </div>
                
                <div class="config-item">
                    <label>üìä Status Token:</label>
                    <div id="tokenStatus" class="status-indicator">‚ùå Token non configurato</div>
                </div>
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 15px;">
                <button class="btn" id="salvaTokenBtn" style="background: #14b8a6;">
                    üíæ SALVA TOKEN GITHUB
                </button>
                <button class="btn" id="logoutBtn" style="background: #dc3545; display: none;">
                    üö™ LOGOUT
                </button>
            </div>
        </div>

        <!-- Configurazione Backend -->
        <div class="section">
            <h2>‚öôÔ∏è Configurazione Backend</h2>
            
            <div class="config-grid">
                <div class="config-item">
                    <label>üõ°Ô∏è Sistema Email:</label>
                    <div class="api-endpoint">info@dms.associates configurato con PostaSSL</div>
                </div>
            </div>
        </div>

        <!-- Generazione Token di Accesso -->
        <div class="section">
            <h2>üöÄ Generazione Token di Accesso</h2>
            
            <div class="config-grid">
                <div class="config-item">
                    <label>üìß Email Destinatario:</label>
                    <input type="email" id="emailDestinatario" placeholder="checchi@me.com">
                    <small style="color: rgba(255,255,255,0.7);">Inserisci l'email reale del destinatario</small>
                </div>
                
                <div class="config-item">
                    <label>üéØ Area di Accesso:</label>
                    <select id="areaAccesso">
                        <option value="admin">Admin - Accesso Completo</option>
                        <option value="viewer">Viewer - Solo Lettura</option>
                        <option value="editor">Editor - Modifica Contenuti</option>
                    </select>
                </div>
            </div>

            <div class="config-item">
                <label>‚è∞ Durata Sessione (dalla risposta email):</label>
                <select id="durataSessione">
                    <option value="60">60 minuti (standard)</option>
                    <option value="30">30 minuti</option>
                    <option value="120">2 ore</option>
                    <option value="360">6 ore</option>
                    <option value="1440">24 ore</option>
                </select>
            </div>

            <div class="info-box" style="background: rgba(255, 165, 0, 0.1); border: 1px solid #ffa500; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                <strong>üöÄ Sistema GitHub Issues:</strong> Il sistema crea automaticamente un Issue GitHub che attiva il workflow SMTP<br>
                <strong>üìß Email automatica:</strong> L'email viene inviata da <strong>info@dms.associates</strong> tramite PostaSSL<br>
                <strong>‚ö†Ô∏è Importante:</strong> Il destinatario deve <strong style="color: #ffa500;">RISPONDERE ALL'EMAIL</strong> per attivare la sessione
            </div>

            <button class="btn" id="generaTokenBtn">
                üöÄ GENERA TOKEN + INVIA EMAIL REALE
            </button>

            <div id="errorMessage" class="error-message hidden"></div>
            <div id="successMessage" class="success-message hidden"></div>
        </div>

        <!-- Come Funziona il Sistema -->
        <div class="section">
            <h2>üîÑ Come Funziona il Sistema (Logica Timer Corretta)</h2>
            
            <ol class="steps-list">
                <li>
                    <div class="step-number">1</div>
                    <div>
                        <strong>Genera Token:</strong> Inserisci email destinatario e clicca "Genera Token"
                    </div>
                </li>
                <li>
                    <div class="step-number">2</div>
                    <div>
                        <strong>Issue GitHub:</strong> Sistema crea Issue che attiva il workflow SMTP per invio email reale
                    </div>
                </li>
                <li>
                    <div class="step-number">3</div>
                    <div>
                        <strong>Ricezione:</strong> Destinatario riceve email con link personalizzato
                    </div>
                </li>
                <li>
                    <div class="step-number">4</div>
                    <div>
                        <strong>Risposta Richiesta:</strong> Destinatario deve <strong style="color: #ffa500;">RISPONDERE ALL'EMAIL</strong> per attivare la sessione
                    </div>
                </li>
                <li>
                    <div class="step-number">5</div>
                    <div>
                        <strong class="timer-highlight">üî• TIMER PARTE QUI:</strong> Solo quando arriva la risposta inizia il countdown
                    </div>
                </li>
                <li>
                    <div class="step-number">6</div>
                    <div>
                        <strong>Attivazione:</strong> Sessione si attiva per la durata scelta
                    </div>
                </li>
                <li>
                    <div class="step-number">7</div>
                    <div>
                        <strong>Accesso:</strong> Destinatario clicca link e accede al sito
                    </div>
                </li>
                <li>
                    <div class="step-number">8</div>
                    <div>
                        <strong>Scadenza:</strong> Alla scadenza, serve nuova risposta per riattivare
                    </div>
                </li>
            </ol>
        </div>

        <!-- Sessioni Attive -->
        <div class="section">
            <h2>üìä Sessioni Attive</h2>
            
            <button class="btn" id="caricaSessioniBtn">
                üîç CARICA SESSIONI DAL BACKEND
            </button>

            <div class="sessions-container" id="sessionsContainer">
                <p style="text-align: center; color: rgba(255,255,255,0.7);">
                    Clicca "Carica Sessioni" per visualizzare le sessioni attive dal backend
                </p>
            </div>
        </div>

        <!-- API Endpoints -->
        <div class="section">
            <h2>üîó API Endpoints</h2>
            <p>Endpoints disponibili per l'integrazione:</p>
            
            <div style="margin-top: 15px;">
                <strong>Genera Token:</strong>
                <div class="api-endpoint">POST /api/generate-token</div>
                
                <strong>Verifica Accesso:</strong>
                <div class="api-endpoint">POST /api/verify-access</div>
                
                <strong>Sessioni Attive:</strong>
                <div class="api-endpoint">GET /api/sessions</div>
                
                <strong>Test Sistema:</strong>
                <div class="api-endpoint">POST /api/test-email</div>
            </div>
        </div>
    </div>

    <script>
        // Configurazione sistema
        const CONFIG = {
            backendUrl: 'https://chcndr.github.io/dms-sicurezza-mail-test/api',
            emailFrom: 'info@dms.associates',
            smtpConfig: {
                host: 'out.postassl.it',
                port: 465,
                secure: true
            },
            imapConfig: {
                host: 'in.postassl.it',
                port: 993,
                secure: true
            }
        };

        // Elementi DOM
        const elements = {
            systemStatus: document.getElementById('systemStatus'),
            emailDestinatario: document.getElementById('emailDestinatario'),
            areaAccesso: document.getElementById('areaAccesso'),
            durataSessione: document.getElementById('durataSessione'),
            generaTokenBtn: document.getElementById('generaTokenBtn'),
            caricaSessioniBtn: document.getElementById('caricaSessioniBtn'),
            errorMessage: document.getElementById('errorMessage'),
            successMessage: document.getElementById('successMessage'),
            sessionsContainer: document.getElementById('sessionsContainer'),
            githubToken: document.getElementById('githubToken'),
            salvaTokenBtn: document.getElementById('salvaTokenBtn'),
            tokenStatus: document.getElementById('tokenStatus'),
            logoutBtn: document.getElementById('logoutBtn')
        };

        // Inizializzazione sistema
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üîê DMS Email Security System inizializzato');
            checkSystemStatus();
            checkTokenStatus();
            setupEventListeners();
            
            // Sincronizzazione automatica ogni 30 secondi
            setInterval(async () => {
                try {
                    await syncSessionsStatus();
                    console.log('üîÑ Sincronizzazione automatica completata');
                } catch (error) {
                    console.warn('‚ö†Ô∏è Errore sincronizzazione automatica:', error);
                }
            }, 30000);
        });

        // Setup event listeners
        function setupEventListeners() {
            elements.generaTokenBtn.addEventListener('click', generaTokenEInviaEmail);
            elements.caricaSessioniBtn.addEventListener('click', caricaSessioniAttive);
            elements.salvaTokenBtn.addEventListener('click', salvaTokenGithub);
            elements.logoutBtn.addEventListener('click', logoutToken);
        }

        // Verifica status sistema
        async function checkSystemStatus() {
            try {
                if (!elements.systemStatus) {
                    console.error('Elemento systemStatus non trovato');
                    return;
                }
                
                elements.systemStatus.innerHTML = '<div class="loading"></div><span>Verificando...</span>';
                
                // Attesa breve per simulare verifica
                setTimeout(() => {
                    try {
                        // Sistema sempre online per GitHub Pages
                        elements.systemStatus.className = 'status-indicator status-online';
                        elements.systemStatus.innerHTML = '‚úÖ Online';
                        console.log('‚úÖ Sistema verificato e online');
                    } catch (error) {
                        console.error('‚ùå Errore aggiornamento status:', error);
                        elements.systemStatus.className = 'status-indicator status-offline';
                        elements.systemStatus.innerHTML = '‚ùå Offline';
                    }
                }, 500);
                
            } catch (error) {
                console.error('‚ùå Errore verifica sistema:', error);
                if (elements.systemStatus) {
                    elements.systemStatus.className = 'status-indicator status-offline';
                    elements.systemStatus.innerHTML = '‚ùå Offline';
                }
            }
        }

        // Genera token e invia email
        async function generaTokenEInviaEmail() {
            const email = elements.emailDestinatario.value.trim();
            const area = elements.areaAccesso.value;
            const durata = parseInt(elements.durataSessione.value);

            // Validazione
            if (!email || !isValidEmail(email)) {
                showError('Inserisci un indirizzo email valido');
                return;
            }

            try {
                elements.generaTokenBtn.disabled = true;
                elements.generaTokenBtn.innerHTML = '<div class="loading"></div> Generando token e inviando email...';
                
                hideMessages();

                // Genera token JWT
                const token = generateJWT({
                    sub: email,
                    area: area,
                    duration: durata,
                    exp: Math.floor(Date.now() / 1000) + (24 * 60 * 60), // 24 ore per attivazione
                    jti: generateUniqueId(),
                    email: email
                });

                console.log('üîë Token generato:', token);

                // Salva sessione nel localStorage nel formato corretto per unlock.html
                const sessionKey = `dms_session_${email.replace('@', '_').replace('.', '_')}`;
                const sessionData = {
                    email: email,
                    area: area,
                    token: token,
                    duration: parseInt(durata),
                    created: new Date().toISOString(),
                    replied: false, // Diventa true quando l'utente risponde all'email
                    replyTimestamp: null,
                    status: 'pending', // pending -> active quando risponde
                    expires: null, // Viene calcolato quando risponde (dalla risposta + durata)
                    realEmail: false, // Diventa true quando l'Issue viene creato
                    issueNumber: null,
                    timestamp: Date.now()
                };
                localStorage.setItem(sessionKey, JSON.stringify(sessionData));
                console.log('üíæ Sessione salvata nel formato unlock.html:', sessionKey);

                // Simula invio email tramite GitHub Actions
                await simulateEmailSend(email, token, area, durata);

                showSuccess(`‚úÖ Issue GitHub creato automaticamente! Email in invio a ${email}...
                
üîë Token: ${token.substring(0, 50)}...
üìß Email inviata da: ${CONFIG.emailFrom}
‚è∞ Durata sessione: ${durata} minuti (timer parte alla risposta)
üéØ Area accesso: ${area}

‚úÖ **Sistema automatico:** L'Issue √® stato creato e il workflow SMTP √® attivo!
Il destinatario deve rispondere all'email per attivare la sessione.`);

            } catch (error) {
                console.error('‚ùå Errore:', error);
                showError('Errore durante la generazione del token o invio email: ' + error.message);
            } finally {
                elements.generaTokenBtn.disabled = false;
                elements.generaTokenBtn.innerHTML = 'üöÄ GENERA TOKEN + INVIA EMAIL REALE';
            }
        }

        // Invio email reale tramite GitHub Issues (sistema testato e funzionante)
        async function simulateEmailSend(email, token, area, durata) {
            const accessLink = `https://chcndr.github.io/dms-sicurezza-mail-test/landing/unlock.html?t=${token}`;
            const subject = `üîê DMS Security - Accesso ${area.toUpperCase()} (${durata} min)`;
            
            // Verifica che il token GitHub sia configurato
            const githubToken = localStorage.getItem('dms_github_token');
            if (!githubToken) {
                throw new Error('Token GitHub non configurato');
            }
            
            try {
                console.log('üìß Creando Issue GitHub automaticamente via API...');
                
                // Crea Issue GitHub con il payload per il workflow email
                const issuePayload = {
                    to: email,
                    cc: 'dms-sicurezza-mail-test@noreply.github.com',
                    token_link: accessLink,
                    subject: subject,
                    transport: 'smtps',
                    html_extra: `<p><strong>Area di accesso:</strong> ${area}</p><p><strong>Durata sessione:</strong> ${durata} minuti</p><p><strong>Importante:</strong> Rispondi a questa email per attivare la sessione.</p><p><small>Sistema di sblocco: dms-sicurezza-mail-test@noreply.github.com</small></p>`
                };

                // Crea il body dell'Issue con il formato richiesto dal workflow
                const issueBody = `<!--DMS:START-->
\`\`\`json
${JSON.stringify(issuePayload, null, 2)}
\`\`\`
<!--DMS:END-->

**Sistema di Invio Email DMS**

Questo Issue attiva automaticamente l'invio di un'email di accesso tramite il workflow GitHub Actions.

**Dettagli:**
- **Destinatario:** ${email}
- **Area di accesso:** ${area}
- **Durata sessione:** ${durata} minuti
- **Link di accesso:** ${accessLink}

Il workflow invier√† l'email utilizzando il server SMTP configurato (info@dms.associates via PostaSSL).`;

                // Crea Issue automaticamente via API GitHub
                const response = await fetch('https://api.github.com/repos/Chcndr/dms-sicurezza-mail-test/issues', {
                    method: 'POST',
                    headers: {
                        'Authorization': `token ${githubToken}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        title: `DMS: Send Access Email - ${email}`,
                        body: issueBody,
                        labels: ['dispatch-email', 'pending-reply']
                    })
                });

                if (!response.ok) {
                    throw new Error(`Errore API GitHub: ${response.status}`);
                }

                const issueData = await response.json();
                console.log('‚úÖ Issue GitHub creato automaticamente:', issueData.number);

                // Aggiorna la sessione con i dati dell'Issue GitHub
                const sessionKey = `dms_session_${email.replace('@', '_').replace('.', '_')}`;
                const existingSession = localStorage.getItem(sessionKey);
                if (existingSession) {
                    const sessionData = JSON.parse(existingSession);
                    sessionData.issueNumber = issueData.number;
                    sessionData.issueUrl = issueData.html_url;
                    sessionData.realEmail = true; // Ora √® una email reale con Issue GitHub
                    sessionData.status = 'email_sent'; // Email inviata, in attesa di risposta
                    localStorage.setItem(sessionKey, JSON.stringify(sessionData));
                    console.log('‚úÖ Sessione aggiornata con Issue #' + issueData.number);
                }

                // Attendi un momento per l'attivazione del workflow
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                return {
                    to: email,
                    from: CONFIG.emailFrom,
                    subject: subject,
                    token: token,
                    area: area,
                    duration: durata,
                    link: accessLink,
                    status: 'issue_created',
                    message: 'Issue GitHub creato - Clicca "Submit new issue" per inviare l\'email'
                };
                
            } catch (error) {
                console.error('‚ùå Errore creazione Issue:', error);
                
                return {
                    to: email,
                    from: CONFIG.emailFrom,
                    subject: subject,
                    token: token,
                    area: area,
                    duration: durata,
                    link: accessLink,
                    status: 'error',
                    error: error.message,
                    message: 'Errore nella creazione dell\'Issue GitHub'
                };
            }
        }

        // Sincronizza localStorage con sessions_status.json
        async function syncSessionsStatus() {
            try {
                const response = await fetch('../viewer/sessions_status.json?v=' + Date.now());
                if (response.ok) {
                    const sessionsStatus = await response.json();
                    
                    // Aggiorna localStorage con i nuovi stati
                    for (const statusSession of sessionsStatus.sessions) {
                        if (statusSession.replied) {
                            const sessionKey = `dms_session_${statusSession.email.replace('@', '_').replace('.', '_')}`;
                            const existingSession = localStorage.getItem(sessionKey);
                            
                            if (existingSession) {
                                const sessionData = JSON.parse(existingSession);
                                sessionData.replied = true;
                                sessionData.status = statusSession.status;
                                sessionData.activated = statusSession.activated;
                                localStorage.setItem(sessionKey, JSON.stringify(sessionData));
                                console.log(`üîÑ Sincronizzata sessione: ${statusSession.email} -> ${statusSession.status}`);
                            }
                        }
                    }
                }
            } catch (error) {
                console.warn('‚ö†Ô∏è Errore sincronizzazione sessions_status:', error);
            }
        }

        // Carica sessioni attive
        async function caricaSessioniAttive() {
            try {
                elements.caricaSessioniBtn.disabled = true;
                elements.caricaSessioniBtn.innerHTML = '<div class="loading"></div> Caricando sessioni...';

                // Prima sincronizza con sessions_status.json
                await syncSessionsStatus();

                // Carica sessioni reali dal localStorage
                await new Promise(resolve => setTimeout(resolve, 500));

                // Pulisci sessioni di test vecchie
                const testEmails = ['bebaviola@gmail.com', 'bebaviola@me.com'];
                for (const testEmail of testEmails) {
                    const testKey = `dms_session_${testEmail.replace('@', '_').replace('.', '_')}`;
                    if (localStorage.getItem(testKey)) {
                        localStorage.removeItem(testKey);
                        console.log('üóëÔ∏è Rimossa sessione di test:', testEmail);
                    }
                }

                // Carica solo sessioni reali (con email effettivamente inviate)
                const sessioni = [];
                
                // Cerca tutte le sessioni nel localStorage
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && key.startsWith('dms_session_')) {
                        try {
                            const sessionData = JSON.parse(localStorage.getItem(key));
                            // Filtra solo sessioni con email realmente inviate
                            if (sessionData && sessionData.email && sessionData.realEmail && sessionData.issueNumber) {
                                sessioni.push({
                                    email: sessionData.email,
                                    area: sessionData.area || 'admin',
                                    status: sessionData.replied ? 'Sessione Attiva' : 'In attesa risposta email',
                                    created: sessionData.created || 'N/A',
                                    expires: sessionData.replied ? 
                                        `Scade: ${new Date(sessionData.expires).toLocaleString()}` : 
                                        'Timer non ancora avviato',
                                    issueNumber: sessionData.issueNumber
                                });
                            } else if (sessionData && !sessionData.realEmail) {
                                // Rimuovi sessioni fittizie
                                localStorage.removeItem(key);
                                console.log('üóëÔ∏è Rimossa sessione fittizia:', sessionData.email);
                            }
                        } catch (e) {
                            console.warn('Sessione corrotta ignorata:', key);
                            localStorage.removeItem(key);
                        }
                    }
                }

                displaySessions(sessioni);

            } catch (error) {
                console.error('‚ùå Errore caricamento sessioni:', error);
                elements.sessionsContainer.innerHTML = '<p style="color: #ff4444;">Errore nel caricamento delle sessioni</p>';
            } finally {
                elements.caricaSessioniBtn.disabled = false;
                elements.caricaSessioniBtn.innerHTML = 'üîç CARICA SESSIONI DAL BACKEND';
            }
        }

        // Visualizza sessioni
        function displaySessions(sessioni) {
            if (sessioni.length === 0) {
                elements.sessionsContainer.innerHTML = '<p style="text-align: center; color: rgba(255,255,255,0.7);">Nessuna sessione attiva</p>';
                return;
            }

            let html = '';
            sessioni.forEach(sessione => {
                html += `
                    <div class="session-item">
                        <div>
                            <strong>${sessione.email}</strong><br>
                            <small>Area: ${sessione.area} | Creata: ${sessione.created}</small>
                        </div>
                        <div style="text-align: right;">
                            <div style="color: #ffa500; font-weight: bold;">${sessione.status}</div>
                            <small>${sessione.expires}</small>
                        </div>
                    </div>
                `;
            });

            elements.sessionsContainer.innerHTML = html;
        }

        // Utility functions
        function generateJWT(payload) {
            // Simula generazione JWT (per GitHub Pages)
            const header = btoa(JSON.stringify({alg: 'HS256', typ: 'JWT'}));
            const payloadStr = btoa(JSON.stringify(payload));
            const signature = btoa('dms_security_signature_' + Date.now());
            return `${header}.${payloadStr}.${signature}`;
        }

        function generateUniqueId() {
            return 'dms_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        function isValidEmail(email) {
            return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
        }

        function showError(message) {
            elements.errorMessage.textContent = message;
            elements.errorMessage.classList.remove('hidden');
            elements.successMessage.classList.add('hidden');
        }

        function showSuccess(message) {
            elements.successMessage.innerHTML = message.replace(/\n/g, '<br>');
            elements.successMessage.classList.remove('hidden');
            elements.errorMessage.classList.add('hidden');
        }

        function hideMessages() {
            elements.errorMessage.classList.add('hidden');
            elements.successMessage.classList.add('hidden');
        }

        // === FUNZIONI LOGIN ADMIN ===

        // === GESTIONE TOKEN GITHUB ===
        
        // Controlla se il token √® gi√† salvato
        function checkTokenStatus() {
            try {
                if (!elements.tokenStatus || !elements.salvaTokenBtn || !elements.logoutBtn || !elements.githubToken) {
                    console.error('Elementi token non trovati');
                    return;
                }
                
                const savedToken = localStorage.getItem('dms_github_token');
                
                if (savedToken) {
                    elements.tokenStatus.innerHTML = '‚úÖ Token configurato';
                    elements.tokenStatus.className = 'status-indicator status-online';
                    elements.salvaTokenBtn.style.display = 'none';
                    elements.logoutBtn.style.display = 'inline-block';
                    elements.githubToken.value = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
                    elements.githubToken.disabled = true;
                    console.log('‚úÖ Token GitHub gi√† configurato');
                } else {
                    elements.tokenStatus.innerHTML = '‚ùå Token non configurato';
                    elements.tokenStatus.className = 'status-indicator status-offline';
                    elements.salvaTokenBtn.style.display = 'inline-block';
                    elements.logoutBtn.style.display = 'none';
                    elements.githubToken.disabled = false;
                    console.log('‚ö†Ô∏è Token GitHub non configurato');
                }
            } catch (error) {
                console.error('‚ùå Errore check token status:', error);
            }
        }

        // Salva il token GitHub
        async function salvaTokenGithub() {
            const token = elements.githubToken.value.trim();
            
            if (!token || !token.startsWith('ghp_')) {
                showError('Inserisci un token GitHub valido (inizia con ghp_)');
                return;
            }

            try {
                elements.salvaTokenBtn.disabled = true;
                elements.salvaTokenBtn.innerHTML = '<div class="loading"></div> Verificando token...';
                
                // Testa il token con una chiamata API
                const response = await fetch('https://api.github.com/repos/Chcndr/dms-sicurezza-mail-test', {
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });

                if (response.ok) {
                    // Token valido, salvalo
                    localStorage.setItem('dms_github_token', token);
                    
                    console.log('‚úÖ Token GitHub salvato');
                    showSuccess('‚úÖ Token GitHub salvato! Sistema pronto per creare Issues automaticamente.');
                    
                    // Aggiorna UI
                    checkTokenStatus();
                    
                } else {
                    throw new Error('Token non valido o senza permessi');
                }

            } catch (error) {
                console.error('‚ùå Errore salvataggio token:', error);
                showError('Token non valido. Verifica che abbia i permessi per il repository.');
            } finally {
                elements.salvaTokenBtn.disabled = false;
                elements.salvaTokenBtn.innerHTML = 'üíæ SALVA TOKEN GITHUB';
            }
        }

        // Logout - rimuove il token
        function logoutToken() {
            localStorage.removeItem('dms_github_token');
            
            console.log('üö™ Token GitHub rimosso');
            showSuccess('Token rimosso. Inserisci un nuovo token per continuare.');
            
            // Aggiorna UI
            elements.githubToken.value = '';
            checkTokenStatus();
        }
    </script>
</body>
</html>
