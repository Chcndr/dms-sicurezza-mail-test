<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîí DMS Security - Area Protetta</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: white;
        }
        
        .header {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .header h1 {
            text-align: center;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 20px;
        }
        
        .welcome-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
            margin-bottom: 30px;
            text-align: center;
        }
        
        .session-info {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 25px;
            margin: 30px 0;
            border-left: 4px solid #00d2d3;
        }
        
        .session-info h3 {
            color: #00d2d3;
            margin-bottom: 15px;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .info-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .info-item strong {
            color: #ffd700;
            display: block;
            margin-bottom: 8px;
        }
        
        .actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 30px;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }
        
        .btn-primary {
            background: linear-gradient(45deg, #00d2d3, #00a8a9);
            color: white;
        }
        
        .btn-secondary {
            background: linear-gradient(45deg, #ffd700, #ffb700);
            color: #333;
        }
        
        .btn-danger {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            color: white;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }
        
        .features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-top: 40px;
        }
        
        .feature-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 30px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            text-align: center;
            transition: transform 0.3s ease;
        }
        
        .feature-card:hover {
            transform: translateY(-5px);
        }
        
        .feature-icon {
            font-size: 3em;
            margin-bottom: 20px;
            display: block;
        }
        
        .countdown {
            background: rgba(255, 193, 7, 0.2);
            border: 1px solid rgba(255, 193, 7, 0.5);
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
        }
        
        .countdown-timer {
            font-size: 1.5em;
            font-weight: bold;
            color: #ffd700;
            font-family: 'Courier New', monospace;
        }
        
        .loading {
            text-align: center;
            padding: 50px;
        }
        
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid #00d2d3;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üîí DMS Security - Area Protetta</h1>
    </div>
    
    <div class="container">
        <!-- Loading Screen -->
        <div id="loading" class="loading">
            <div class="spinner"></div>
            <h2>üîç Verifica credenziali in corso...</h2>
            <p>Attendere prego, stiamo controllando i tuoi permessi di accesso.</p>
        </div>
        
        <!-- Main Content -->
        <div id="mainContent" class="hidden">
            <div class="welcome-card">
                <h2>üéâ Benvenuto nell'Area Protetta DMS!</h2>
                <p style="font-size: 1.2em; margin-top: 15px; opacity: 0.9;">
                    Hai effettuato l'accesso con successo al sistema di sicurezza DMS.
                    Questa √® un'area riservata accessibile solo con token JWT validi.
                </p>
            </div>
            
            <!-- Session Information -->
            <div class="session-info">
                <h3>üìä Informazioni Sessione</h3>
                <div class="info-grid">
                    <div class="info-item">
                        <strong>üë§ Utente:</strong>
                        <span id="userEmail">Caricamento...</span>
                    </div>
                    <div class="info-item">
                        <strong>üÜî Subject:</strong>
                        <span id="userSubject">Caricamento...</span>
                    </div>
                    <div class="info-item">
                        <strong>üîë Token ID:</strong>
                        <span id="tokenJti">Caricamento...</span>
                    </div>
                    <div class="info-item">
                        <strong>‚è∞ Scadenza:</strong>
                        <span id="sessionExpiry">Caricamento...</span>
                    </div>
                </div>
                
                <!-- Countdown Timer -->
                <div class="countdown">
                    <div>‚è±Ô∏è <strong>Tempo rimanente:</strong></div>
                    <div id="countdownTimer" class="countdown-timer">Calcolando...</div>
                </div>
            </div>
            
            <!-- Actions -->
            <div class="actions">
                <button class="btn btn-primary" onclick="refreshSession()">
                    üîÑ Aggiorna Sessione
                </button>
                <button class="btn btn-secondary" onclick="showDebugInfo()">
                    üîß Info Debug
                </button>
                <a href="../make-token.html" class="btn btn-secondary">
                    üîë Genera Nuovo Token
                </a>
                <button class="btn btn-danger" onclick="logout()">
                    üö™ Logout
                </button>
            </div>
            
            <!-- Features -->
            <div class="features">
                <div class="feature-card">
                    <span class="feature-icon">üõ°Ô∏è</span>
                    <h3>Sicurezza Avanzata</h3>
                    <p>Sistema di autenticazione basato su JWT con verifica whitelist in tempo reale.</p>
                </div>
                
                <div class="feature-card">
                    <span class="feature-icon">‚è∞</span>
                    <h3>Sessioni Temporizzate</h3>
                    <p>Accesso limitato nel tempo con scadenza automatica per massima sicurezza.</p>
                </div>
                
                <div class="feature-card">
                    <span class="feature-icon">üìß</span>
                    <h3>Autenticazione Email</h3>
                    <p>Verifica dell'identit√† tramite email con sistema di risposta automatica.</p>
                </div>
                
                <div class="feature-card">
                    <span class="feature-icon">üîÑ</span>
                    <h3>Aggiornamenti Real-time</h3>
                    <p>Controllo continuo dei permessi con aggiornamento automatico della whitelist.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Include Auth Gate -->
    <script src="../auth-gate.js"></script>
    
    <script>
        let countdownInterval;
        
        // Inizializza l'applicazione
        async function initApp() {
            try {
                // Verifica l'accesso
                const result = await window.DMS_SESSION.init({ 
                    debug: true,
                    whitelistUrl: './whitelist.json',
                    redirectUrl: '../make-token.html'
                });
                
                if (result.success) {
                    showMainContent();
                    updateSessionInfo();
                    startCountdown();
                } else {
                    // L'auth gate gestir√† automaticamente il redirect
                    console.log('Accesso negato:', result.reason);
                }
            } catch (error) {
                console.error('Errore inizializzazione:', error);
                showError('Errore durante l\'inizializzazione del sistema');
            }
        }
        
        // Mostra il contenuto principale
        function showMainContent() {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('mainContent').classList.remove('hidden');
        }
        
        // Aggiorna le informazioni della sessione
        function updateSessionInfo() {
            const session = window.DMS_SESSION.get();
            if (!session) return;
            
            document.getElementById('userEmail').textContent = session.email || 'N/A';
            document.getElementById('userSubject').textContent = session.subject || 'N/A';
            document.getElementById('tokenJti').textContent = session.jti || 'N/A';
            document.getElementById('sessionExpiry').textContent = 
                session.expires ? session.expires.toLocaleString('it-IT') : 'N/A';
        }
        
        // Avvia il countdown
        function startCountdown() {
            const session = window.DMS_SESSION.get();
            if (!session || !session.expires) return;
            
            countdownInterval = setInterval(() => {
                const now = new Date();
                const timeLeft = session.expires - now;
                
                if (timeLeft <= 0) {
                    clearInterval(countdownInterval);
                    document.getElementById('countdownTimer').textContent = 'SCADUTO';
                    setTimeout(() => {
                        alert('‚è∞ Sessione scaduta! Verrai reindirizzato alla pagina di login.');
                        logout();
                    }, 1000);
                    return;
                }
                
                const hours = Math.floor(timeLeft / (1000 * 60 * 60));
                const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);
                
                document.getElementById('countdownTimer').textContent = 
                    `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }, 1000);
        }
        
        // Aggiorna la sessione
        function refreshSession() {
            updateSessionInfo();
            
            // Feedback visivo
            const btn = event.target;
            const originalText = btn.textContent;
            btn.textContent = 'üîÑ Aggiornando...';
            btn.disabled = true;
            
            setTimeout(() => {
                btn.textContent = originalText;
                btn.disabled = false;
                alert('‚úÖ Sessione aggiornata!');
            }, 1000);
        }
        
        // Mostra informazioni di debug
        function showDebugInfo() {
            const session = window.DMS_SESSION.get();
            if (!session) {
                alert('‚ùå Nessuna sessione attiva');
                return;
            }
            
            const debugInfo = `
üîê DMS Debug Information

üë§ Email: ${session.email}
üÜî Subject: ${session.subject}
üîë Token ID: ${session.jti}
‚è∞ Scadenza: ${session.expires.toLocaleString('it-IT')}
‚úÖ Valida: ${session.isValid ? 'S√¨' : 'No'}

üïí Timestamp corrente: ${new Date().toLocaleString('it-IT')}
            `;
            
            alert(debugInfo);
        }
        
        // Logout
        function logout() {
            if (confirm('üö™ Sei sicuro di voler effettuare il logout?')) {
                if (countdownInterval) {
                    clearInterval(countdownInterval);
                }
                window.DMS_SESSION.logout();
            }
        }
        
        // Mostra errore
        function showError(message) {
            document.getElementById('loading').innerHTML = `
                <div style="color: #ff4757;">
                    <h2>‚ùå Errore</h2>
                    <p>${message}</p>
                    <button onclick="location.reload()" class="btn btn-primary" style="margin-top: 20px;">
                        üîÑ Riprova
                    </button>
                </div>
            `;
        }
        
        // Avvia l'applicazione quando il DOM √® pronto
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initApp);
        } else {
            initApp();
        }
        
        // Gestione della visibilit√† della pagina
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                // Ricontrolla la sessione quando la pagina diventa visibile
                const session = window.DMS_SESSION.get();
                if (!session || !session.isValid) {
                    alert('‚ö†Ô∏è Sessione non pi√π valida. Reindirizzamento in corso...');
                    logout();
                }
            }
        });
    </script>
</body>
</html>
