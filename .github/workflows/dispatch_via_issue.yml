name: DMS – Dispatch email via Issue
on:
  issues:
    types: [opened]
permissions:
  contents: read
  issues: write
jobs:
  send_email:
    if: contains(github.event.issue.labels.*.name, 'dispatch-email')
    runs-on: ubuntu-latest
    steps:
      - name: Parse payload from Issue body
        id: parse
        env:
          GITHUB_EVENT_PATH: ${{ github.event_path }}
        run: |
          python - <<'PY'
          import os, json, re, sys, html
          ev = json.load(open(os.environ['GITHUB_EVENT_PATH']))
          issue = ev['issue']
          body = issue.get('body') or ''
          issue_number = issue.get('number', '')
          
          m = re.search(r'<!--DMS:START-->\s*```json\s*(\{.*?\})\s*```\s*<!--DMS:END-->', body, re.S)
          if not m:
            print('::error ::Blocco JSON non trovato (<!--DMS:START--> ... <!--DMS:END-->)'); sys.exit(1)
          try:
            data = json.loads(m.group(1))
          except Exception as e:
            print('::error ::JSON non valido:', e); sys.exit(1)
          for k in ('to','token_link'):
            if not data.get(k):
              print(f'::error ::Campo mancante: {k}'); sys.exit(1)
          
          # Crea Reply-To speciale per collegare alla Issue
          reply_to = f"dms-reply-{issue_number}@dms.associates"
          
          # sanitize basic fields
          out = os.environ['GITHUB_OUTPUT']
          with open(out,'a') as f:
            for k,v in data.items():
              f.write(f"{k}={str(v).strip()}\n")
            f.write(f"reply_to={reply_to}\n")
            f.write(f"issue_number={issue_number}\n")
          PY

      - name: Send email via SMTP (465 SMTPS)
        if: ${{ !contains(steps.parse.outputs.transport, 'starttls') }}
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: out.postassl.it
          server_port: 465
          secure: true
          username: ${{ secrets.IMAP_USER }}
          password: ${{ secrets.IMAP_PASS }}
          subject: ${{ steps.parse.outputs.subject || format('DMS – Accesso [jti={0}]', steps.parse.outputs.jti) }}
          to: ${{ steps.parse.outputs.to }}
          from: ${{ steps.parse.outputs.from || secrets.IMAP_USER }}
          reply_to: ${{ steps.parse.outputs.reply_to }}
          html_body: |
            <h3>🔐 DMS Security - Link di Accesso</h3>
            <p>Ciao,</p>
            <p><strong>Il tuo link di accesso:</strong><br>
            <a href="${{ steps.parse.outputs.token_link }}" style="background: #007cba; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px;">🚀 ACCEDI AL SISTEMA</a></p>
            
            <p><strong>⚠️ IMPORTANTE:</strong> Per attivare la sessione, <strong>RISPONDI A QUESTA EMAIL</strong> con qualsiasi messaggio (anche solo "OK").</p>
            
            <p><strong>Come funziona:</strong></p>
            <ol>
              <li>📧 <strong>Rispondi a questa email</strong> → Sistema si attiva automaticamente</li>
              <li>🔗 <strong>Clicca il link sopra</strong> → Accedi al sistema</li>
              <li>⏰ <strong>Sessione attiva per ${{ steps.parse.outputs.duration || '60' }} minuti</strong></li>
            </ol>
            
            <hr>
            <p><small>Sistema di sicurezza DMS - Issue #${{ steps.parse.outputs.issue_number }}</small></p>
          ignore_cert: false

      - name: Send email via SMTP (587 STARTTLS)
        if: ${{ contains(steps.parse.outputs.transport, 'starttls') }}
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: out.postassl.it
          server_port: 587
          secure: false
          username: ${{ secrets.IMAP_USER }}
          password: ${{ secrets.IMAP_PASS }}
          subject: ${{ steps.parse.outputs.subject || format('DMS – Accesso [jti={0}]', steps.parse.outputs.jti) }}
          to: ${{ steps.parse.outputs.to }}
          from: ${{ steps.parse.outputs.from || secrets.IMAP_USER }}
          reply_to: ${{ steps.parse.outputs.reply_to }}
          html_body: |
            <h3>🔐 DMS Security - Link di Accesso</h3>
            <p>Ciao,</p>
            <p><strong>Il tuo link di accesso:</strong><br>
            <a href="${{ steps.parse.outputs.token_link }}" style="background: #007cba; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px;">🚀 ACCEDI AL SISTEMA</a></p>
            
            <p><strong>⚠️ IMPORTANTE:</strong> Per attivare la sessione, <strong>RISPONDI A QUESTA EMAIL</strong> con qualsiasi messaggio (anche solo "OK").</p>
            
            <p><strong>Come funziona:</strong></p>
            <ol>
              <li>📧 <strong>Rispondi a questa email</strong> → Sistema si attiva automaticamente</li>
              <li>🔗 <strong>Clicca il link sopra</strong> → Accedi al sistema</li>
              <li>⏰ <strong>Sessione attiva per ${{ steps.parse.outputs.duration || '60' }} minuti</strong></li>
            </ol>
            
            <hr>
            <p><small>Sistema di sicurezza DMS - Issue #${{ steps.parse.outputs.issue_number }}</small></p>
          ignore_cert: false

      - name: Comment esito
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          issue_url="${{ github.event.issue.url }}/comments"
          body='{"body":"✅ Email inviata a **'"${{ steps.parse.outputs.to }}"'**.\n"}'
          curl -sS -H "Authorization: token ${GH_TOKEN}" -H "Accept: application/vnd.github+json" -d "$body" "$issue_url" >/dev/null
